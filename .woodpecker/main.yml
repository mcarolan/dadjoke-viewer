# .woodpecker/dadjoke-viewer.yml
steps:
  setup:
    image: node:20
    commands:
      - echo "Installing dependencies..."
      - npm ci

  run-tests:
    image: node:20
    commands:
      - echo "Running Pact consumer tests..."
      - npm run test:pact

  publish-pact:
    image: node:20
    commands:
      - echo "Publishing pacts..."
      - docker run --rm --network host \
          -e PACT_BROKER_BASE_URL=http://pact-broker:9292 \
          -v $(pwd)/pacts:/pacts \
          pactfoundation/pact-cli:latest \
          publish /pacts --consumer-app-version "$(git rev-parse --short HEAD)"